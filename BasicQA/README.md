# Usage example at Virgo
At first, open singularity enviroment: 
``` bash
singularity shell -B /lustre /lustre/alice/users/szhu/share/root_npm.sif
```
Then, compile the code. At the path where Makefile exsits.
```bash
make all
```
Practical example paths: (NOTE: please use your own paths for usage in all these macros)
* for PbPb, /lustre/alice/users/szhu/work/GSI_TPC_QC/output/LHC23zz_fghiklmno_pass5
``` bash
cd tree_bb/ ; ./run.sh ; cd ../ ; cd tree_nn/ ; ./run.sh ; cd ../ ; cd hist_bb/ ; ./run.sh ; cd ../ ; cd hist_nn/ ; ./run.sh ; cd ../ ; ./run2.sh ;export NODE_PATH=/usr/lib/node_modules/ï¼› ./getHtml.sh
```
Directories is named as run period.
/lustre/alice/users/szhu/work/GSI_TPC_QC/output/LHC24ar_pass2/run2.sh is unique where only BB plots are drawn.

* for pp, /lustre/alice/users/szhu/work/GSI_TPC_QC/output/LHC24_ap_aq_pass1
  It's very similar with PbPb case. The difference is that the plots related to FT0C occupancy is removed because the FT0C occupancy is unnecessary for pp.

* Upload the plots to the web repository.
```bash
# example
cd /lustre/alice/users/szhu/work/GSI_TPC_QC/output
find ./ -name "*html" -exec cp --parents -t ../html/ {} +
cd /lustre/alice/users/szhu/work/GSI_TPC_QC/html
rm file_list.txt
find ./ -mindepth 2 -name "index.html" -exec rm {} +
for i in `ls` ; do [ -d ${i} ] && echo ${i}/ ; done > file_list.txt
for i in `ls` ; do if [ -d ${i} ] ; then cd ${i}; ls *html > file_list.txt ; cd .. ; cp index.html ${i} ; fi ; done
cd ../
rsync -avz -process -e "ssh" ./html/* your_lxplus_username@lxplus.cern.ch:/eos/project/a/alice-tpc-pid/www
```

> **Note:** The information below is generated by AI.

# PID QA Analysis Code

This repository contains code for the PID QA analysis, which focuses on particle identification and separation power analysis.

## Overview

The analysis includes:
- Skim tree reading and processing
- Separation power calculation
- Run-dependent profile analysis
- Quality assurance checks
- nSigma plotting for PID analysis

## Directory Structure

- `macro/`: Contains ROOT macros for various analysis tasks
- `draw/`: Contains C++ programs for drawing and visualization
- `process/`: Contains C++ programs for processing and analysis
- `Makefile`: Build system for compiling the C++ programs

## Build Instructions

To compile all the programs, run:
```bash
make all
```

## Programs and Macros

### Makefile
This Makefile is used to compile the PID QA analysis code. It defines the build process for several executables:

- `macro/SkimTreeReading.exe`: Compiled from `macro/SkimTreeReading.C`
- `draw/ComparisonSeparationPower.exe`: Compiled from `draw/ComparisonSeparationPower.cpp`
- `draw/RunDependentProfile.exe`: Compiled from `draw/RunDependentProfile.cpp`
- `process/SeparationPower.exe`: Compiled from `process/SeparationPower.cpp`

The Makefile uses environment variables for directories and compiler flags:
- `DIR_BASE` and `DIR_BASE2`: Base directories for the analysis
- `FLAGS_INCLUDE`: Include directories and compiler flags
- `FLAGS_ROOT`: ROOT library flags
- `FLAGS_MINUIT`: Minuit library flags

To build all targets, run `make`.

### macro/SkimTreeReading.C
This macro performs skim tree reading and analysis for the PID QA analysis. It uses ROOT's RDataFrame for efficient data processing.

Key features:
- Opens and processes TTree data using ROOT::RDataFrame
- Defines various aliases and computed quantities:
  - `nCluster`: Computed from normalized TPC clusters
  - `dEdx_exp`: Expected dE/dx calculation
  - `delta_dEdx`: Difference between measured and expected dE/dx
  - Particle identification filters (electron, pion, proton)
- Creates 2D histograms for separation power analysis
- Supports multiple conditions for analysis:
  - Different cluster count ranges (highNcls, lowNcls, AllNcls)
  - Different particle types (Electron, Pion)
- Outputs results to a ROOT file

To compile: `make macro/SkimTreeReading.exe`
To run: `./macro/SkimTreeReading.exe`

### draw/ComparisonSeparationPower.cpp
This program compares separation power between different data sets (NN and BB) for the PID QA analysis.

Key features:
- Compares separation power metrics between two ROOT files (NN and BB data)
- Creates detailed plots for various variables:
  - dEdx (mean and sigma)
  - delta_dEdx (mean and sigma)
  - For both electrons and pions
- Supports different cluster count conditions (highNcls, lowNcls, AllNcls)
- Can toggle occupancy plots on/off
- Generates both detailed plots and summary separation power plots
- Outputs plots in JSON format

To compile: `make draw/ComparisonSeparationPower.exe`
To run: `./draw/ComparisonSeparationPower.exe`

### draw/RunDependentProfile.cpp
This program analyzes run-dependent profiles for the PID QA analysis, comparing different data sets (NN and BB).

Key features:
- Analyzes run-dependent profiles from two ROOT files (NN and BB data)
- Creates detailed plots for various variables:
  - dEdx (mean)
  - dEdx_exp (mean)
  - delta_dEdx (sigma)
  - fNSigTPC (mean)
- Supports different cluster count conditions (highNcls, lowNcls, AllNcls)
- Compares profiles for both electrons and pions
- Outputs plots in JSON format
- Configurable via command line arguments

Command line arguments:
- argv[1]: Path to NN input ROOT file (default: ~/test/sepPower_nn.root)
- argv[2]: Path to BB input ROOT file (default: ~/test/sepPower_bb.root)
- argv[3]: Output graph path (default: ~/test/sepPower_graph)
- argv[4]: NN tag (default: NN)
- argv[5]: BB tag (default: BB)

To compile: `make draw/RunDependentProfile.exe`
To run: `./draw/RunDependentProfile.exe [input_nn] [input_bb] [output] [tag_nn] [tag_bb]`

### process/SeparationPower.cpp
This program calculates separation power between different particle types for the PID QA analysis.

Key features:
- Calculates separation power between electrons and pions using dE/dx measurements
- Supports both NN (Neural Network) and BB (Boosted Decision Tree) algorithms
- Analyzes multiple variables:
  - dEdx (measured and expected)
  - delta_dEdx (difference between measured and expected)
- Supports different cluster count conditions (highNcls, lowNcls, AllNcls)
- Uses Gaussian fitting for mean and sigma calculations
- Outputs results to a ROOT file

Command line arguments:
- argv[1]: Input ROOT file path (default: ~/test/output.root)
- argv[2]: Output ROOT file path (default: ~/test/sepPower.root)
- argv[3]: Algorithm type (0 for NN, 1 for BB, default: 0)

To compile: `make process/SeparationPower.exe`
To run: `./process/SeparationPower.exe [input] [output] [algorithm]`

### QA Macros

#### QACheck_4DHistos_electron_TPC.C
This macro performs Quality Assurance (QA) checks on 4D histograms for electron TPC (Time Projection Chamber) analysis.

Key features:
- Analyzes 4D sparse histograms (THnSparse) for TPC PID QA
- Projects 4D histograms into 1D distributions for analysis
- Performs Gaussian fits on nSigma distributions
- Supports both TPC-only and TPC+TOF analysis
- Configurable binning and cut parameters for:
  - TPC cluster counts (60-160)
  - Momentum (0.6-5.0 GeV/c)
  - Pseudorapidity (-0.9 to 0.9)
- Outputs fit results and projections to files

To run: `root -l -b -q QACheck_4DHistos_electron_TPC.C'("input_file.root", "output_path")'`

#### QACheck_4DHistos_electron_V0.C
This macro performs Quality Assurance (QA) checks on 4D histograms for electron V0 (Vertex) analysis.

Key features:
- Similar functionality to QACheck_4DHistos_electron_TPC.C but for V0 analysis
- Analyzes 4D sparse histograms for V0 PID QA
- Projects 4D histograms into 1D distributions for analysis
- Performs Gaussian fits on nSigma distributions
- Configurable binning and cut parameters
- Outputs fit results and projections to files

To run: `root -l -b -q QACheck_4DHistos_electron_V0.C'("input_file.root", "output_path")'`

#### QACheck_4DHistos_TPC.C
This macro performs Quality Assurance (QA) checks on 4D histograms for TPC (Time Projection Chamber) analysis.

Key features:
- General TPC QA analysis for multiple particle types
- Analyzes 4D sparse histograms for TPC PID QA
- Projects 4D histograms into 1D distributions for analysis
- Performs Gaussian fits on nSigma distributions
- Supports both TPC-only and TPC+TOF analysis
- Configurable binning and cut parameters
- Outputs fit results and projections to files

To run: `root -l -b -q QACheck_4DHistos_TPC.C'("input_file.root", "output_path")'`

#### QACheck_4DHistos_V0.C
This macro performs Quality Assurance (QA) checks on 4D histograms for V0 (Vertex) analysis.

Key features:
- General V0 QA analysis for multiple particle types
- Analyzes 4D sparse histograms for V0 PID QA
- Projects 4D histograms into 1D distributions for analysis
- Performs Gaussian fits on nSigma distributions
- Configurable binning and cut parameters
- Outputs fit results and projections to files

To run: `root -l -b -q QACheck_4DHistos_V0.C'("input_file.root", "output_path")'`

#### QAPIDqaReport_optimized.C
This macro generates optimized PID (Particle Identification) QA reports for TPC and TOF detectors.

Key features:
- Generates PDF reports for PID QA analysis
- Supports both TPC and TOF PID analysis
- Creates 2D histogram projections with Gaussian fits
- Automated style setup for consistent plotting
- Configurable output formats

To run: `root -l -b -q QAPIDqaReport_optimized.C'("input_file.root", "output_file.pdf")'`

#### QAPIDTPC_V0.C
This macro performs PID (Particle Identification) analysis for TPC and V0 detectors.

Key features:
- Analyzes PID performance for TPC and V0 detectors
- Creates efficiency and purity plots
- Supports multiple particle types
- Configurable analysis parameters
- Outputs results to ROOT files or PDF reports

To run: `root -l -b -q QAPIDTPC_V0.C'("input_file.root", "output_file")'`

### draw/NSigmaPlotting.cpp
This program creates nSigma plots for particle identification analysis.

Key features:
- Analyzes nSigma distributions for different particle types
- Supports multiple conditions:
  - Different particle types (electron, pion)
  - Different cluster count ranges (highNcls, lowNcls, AllNcls)
- Creates 2D histograms of mean and sigma vs. momentum
- Performs Gaussian fits to extract mean and sigma values
- Outputs results to a ROOT file

Default parameters:
- Input file: /home/szhu/test/SkimmingTreeRead.root
- Output file: ./testPlot.root

To run: `./draw/NSigmaPlotting.exe [input_file] [output_file]`

## Usage Workflow

1. Start by running the skim tree reading macro to process the input data
2. Use the separation power program to calculate separation metrics
3. Generate comparison plots using the drawing programs
4. Create QA reports using the QA macros
5. Generate nSigma plots for PID analysis

## Dependencies

- ROOT data analysis framework
- C++ compiler with C++11 support
- Make build system

## Note

All the code is designed to work within the PID QA analysis framework and assumes specific data structures and formats.
